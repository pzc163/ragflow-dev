# MinerU ä»»åŠ¡æœåŠ¡é›†æˆåŠŸèƒ½

## æ¦‚è¿°

`task_service.py` å·²æˆåŠŸé›†æˆ MinerU è§£æå™¨æ”¯æŒï¼Œæä¾›äº†å®Œæ•´çš„ PDF â†’ Markdown â†’ RAGFlow å¤„ç†æµç¨‹çš„ä»»åŠ¡ç®¡ç†åŠŸèƒ½ã€‚

## æ–°å¢åŠŸèƒ½

### 1. MinerU ä»»åŠ¡åˆ›å»º (`queue_tasks`)

**ç‰¹ç‚¹ï¼š**
- ğŸ“„ ä¸“é—¨é’ˆå¯¹ PDF æ–‡ä»¶çš„éªŒè¯å’Œå¤„ç†
- ğŸ” MinerU æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
- ğŸ“Š æ™ºèƒ½æ–‡ä»¶å¤§å°è¯„ä¼°å’Œä»»åŠ¡ä¼˜åŒ–
- ğŸ”„ è‡ªåŠ¨å›é€€æœºåˆ¶æ”¯æŒ
- âš¡ å•ä»»åŠ¡å¤„ç†æ•´ä¸ªæ–‡æ¡£ï¼ˆä¸åˆ†é¡µï¼‰

**å¤„ç†é€»è¾‘ï¼š**
```python
elif doc["parser_id"] == "mineru":
    # 1. æ–‡ä»¶ç±»å‹éªŒè¯
    # 2. æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
    # 3. PDF æ–‡ä»¶éªŒè¯
    # 4. ä»»åŠ¡å…ƒæ•°æ®è®¾ç½®
    # 5. ä¼˜å…ˆçº§è°ƒæ•´
```

**ä»»åŠ¡å…ƒæ•°æ®ï¼š**
- `parser_type`: "mineru_markdown"
- `total_pages`: å®é™… PDF é¡µæ•°
- `file_size`: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- `service_available`: æœåŠ¡çŠ¶æ€
- `estimated_time`: "short"/"medium"/"long"
- `timeout_multiplier`: è¶…æ—¶å€æ•°

### 2. æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥

**åŠŸèƒ½ï¼š** `_check_mineru_service_availability()`
- âœ… è‡ªåŠ¨æ£€æµ‹ MinerU æœåŠ¡çŠ¶æ€
- ğŸ”§ æ”¯æŒå›é€€æœºåˆ¶é…ç½®
- ğŸ“ è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è®°å½•

### 3. ä»»åŠ¡ä¼˜å…ˆçº§æ™ºèƒ½è°ƒæ•´

**ç­–ç•¥ï¼š**
- ğŸš€ å°æ–‡ä»¶ï¼ˆ<10MBï¼‰ï¼šæé«˜ä¼˜å…ˆçº§
- âš–ï¸ ä¸­ç­‰æ–‡ä»¶ï¼ˆ10-50MBï¼‰ï¼šæ­£å¸¸ä¼˜å…ˆçº§
- ğŸŒ å¤§æ–‡ä»¶ï¼ˆ>50MBï¼‰ï¼šé™ä½ä¼˜å…ˆçº§
- âš ï¸ æœåŠ¡ä¸å¯ç”¨ï¼šé™ä½ä¼˜å…ˆçº§

### 4. MinerU ä»»åŠ¡è¯¦æƒ…æŸ¥è¯¢

**åŠŸèƒ½ï¼š** `TaskService.get_mineru_task_details(task_id)`

**è¿”å›ä¿¡æ¯ï¼š**
```python
{
    "id": "ä»»åŠ¡ID",
    "doc_id": "æ–‡æ¡£ID",
    "progress": 0.75,
    "is_completed": False,
    "is_running": True,
    "chunk_count": 42,
    "chunk_list": ["chunk1", "chunk2", ...],
    "estimated_remaining_seconds": 120,
    "total_pages": 25,
    "file_size": 5242880
}
```

### 5. ä»»åŠ¡ç»Ÿè®¡åˆ†æ

**åŠŸèƒ½ï¼š** `get_mineru_task_stats(tenant_id=None)`

**ç»Ÿè®¡æ•°æ®ï¼š**
- ğŸ“ˆ ä»»åŠ¡æ•°é‡ç»Ÿè®¡ï¼ˆæ€»è®¡/å®Œæˆ/è¿è¡Œä¸­/å¤±è´¥ï¼‰
- ğŸ“„ æ–‡æ¡£æ•°é‡å’Œæ–‡ä»¶å¤§å°ç»Ÿè®¡
- ğŸ“Š å®Œæˆç‡å’Œå¹³å‡æ–‡ä»¶å¤§å°
- ğŸ“‹ å¯è¯»æ€§å¼ºçš„æ‘˜è¦ä¿¡æ¯

## é…ç½®é€‰é¡¹

### MinerU é…ç½®å‚æ•°

```python
parser_config = {
    "mineru_fallback": True,      # å¯ç”¨å›é€€æœºåˆ¶
    "mineru_config": {            # MinerU ç‰¹å®šé…ç½®
        "api_endpoint": "http://172.19.0.3:8081/file_parse",
        "api_timeout": 600,
        "parse_method": "auto",
        "return_content_list": True,
        "process_images": True
    }
}
```

### æ–‡ä»¶å¤§å°é˜ˆå€¼

- **å°æ–‡ä»¶**: < 10MB (ä¼˜å…ˆå¤„ç†)
- **ä¸­ç­‰æ–‡ä»¶**: 10MB - 50MB (æ­£å¸¸å¤„ç†)
- **å¤§æ–‡ä»¶**: > 50MB (é™ä½ä¼˜å…ˆçº§)

## ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»º MinerU ä»»åŠ¡

```python
from api.db.services.task_service import queue_tasks

doc = {
    "id": "doc123",
    "parser_id": "mineru",
    "type": "pdf",
    "name": "document.pdf",
    "size": 15728640,  # 15MB
    "parser_config": {
        "mineru_fallback": True,
        "mineru_config": {
            "process_images": True,
            "return_content_list": True
        }
    }
}

queue_tasks(doc, "bucket_name", "document.pdf", priority=0)
```

### æŸ¥è¯¢ä»»åŠ¡è¯¦æƒ…

```python
from api.db.services.task_service import TaskService

# è·å– MinerU ä»»åŠ¡è¯¦æƒ…
task_details = TaskService.get_mineru_task_details("task_id_123")
if task_details:
    print(f"ä»»åŠ¡è¿›åº¦: {task_details['progress']:.1%}")
    print(f"ç”Ÿæˆå—æ•°: {task_details['chunk_count']}")
```

### è·å–ç»Ÿè®¡ä¿¡æ¯

```python
from api.db.services.task_service import get_mineru_task_stats

# è·å–å…¨å±€ç»Ÿè®¡
stats = get_mineru_task_stats()
print(stats["summary"])

# è·å–ç‰¹å®šç§Ÿæˆ·ç»Ÿè®¡
tenant_stats = get_mineru_task_stats("tenant_123")
```

## ä¸åŸæœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

### å®Œå…¨å…¼å®¹çš„æ¥å£
- âœ… `queue_tasks()` å‡½æ•°æ¥å£ä¿æŒä¸å˜
- âœ… ä»»åŠ¡æ•°æ®åº“æ¨¡å‹ä¿æŒå…¼å®¹
- âœ… è¿›åº¦æ›´æ–°æœºåˆ¶ä¿æŒä¸€è‡´
- âœ… å—é‡ç”¨ä¼˜åŒ–æœºåˆ¶æ­£å¸¸å·¥ä½œ

### æ–°å¢çš„ MinerU ç‰¹å®šåŠŸèƒ½
- ğŸ†• æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
- ğŸ†• æ™ºèƒ½ä¼˜å…ˆçº§è°ƒæ•´
- ğŸ†• ä»»åŠ¡è¯¦æƒ…æŸ¥è¯¢
- ğŸ†• ç»Ÿè®¡åˆ†æåŠŸèƒ½

## é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶

### 1. æ–‡ä»¶éªŒè¯å¤±è´¥
```python
# è‡ªåŠ¨æŠ›å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
raise ValueError(f"PDF æ–‡ä»¶éªŒè¯å¤±è´¥: {str(e)}")
```

### 2. æœåŠ¡ä¸å¯ç”¨
```python
# æ ¹æ®é…ç½®å†³å®šå›é€€æˆ–å¤±è´¥
if fallback_enabled:
    logger.warning("MinerU æœåŠ¡ä¸å¯ç”¨ï¼Œå°†å›é€€åˆ°æ ‡å‡†è§£æå™¨")
else:
    raise RuntimeError("MinerU æœåŠ¡ä¸å¯ç”¨ä¸”æœªå¯ç”¨å›é€€æœºåˆ¶")
```

### 3. ä»»åŠ¡æ‰§è¡Œå¤±è´¥
- ğŸ”„ è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- ğŸ“ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ğŸ”§ å¯é…ç½®çš„å›é€€ç­–ç•¥

## æ€§èƒ½ä¼˜åŒ–

### 1. ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†
- å°æ–‡ä»¶ä¼˜å…ˆå¤„ç†ï¼Œæé«˜æ•´ä½“ååé‡
- å¤§æ–‡ä»¶é™ä½ä¼˜å…ˆçº§ï¼Œé¿å…é˜»å¡é˜Ÿåˆ—

### 2. æœåŠ¡çŠ¶æ€ç¼“å­˜
- é¿å…é¢‘ç¹çš„æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
- æ™ºèƒ½çš„å›é€€å†³ç­–

### 3. å—é‡ç”¨æœºåˆ¶
- å®Œå…¨å…¼å®¹åŸæœ‰çš„å—é‡ç”¨ä¼˜åŒ–
- åŸºäºé…ç½®æ‘˜è¦çš„æ™ºèƒ½åŒ¹é…

## ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—è®°å½•
- ğŸ” è¯¦ç»†çš„å¤„ç†æ­¥éª¤è®°å½•
- âš ï¸ æœåŠ¡çŠ¶æ€å˜åŒ–è­¦å‘Š
- ğŸ“Š æ€§èƒ½æŒ‡æ ‡è®°å½•

### ç»Ÿè®¡ç›‘æ§
- ğŸ“ˆ å®æ—¶ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡
- ğŸ“Š å¤„ç†æ€§èƒ½åˆ†æ
- ğŸ¯ æˆåŠŸç‡ç›‘æ§

## æœªæ¥æ‰©å±•

### å¯èƒ½çš„æ”¹è¿›æ–¹å‘
1. **åŠ¨æ€è´Ÿè½½å‡è¡¡**: æ ¹æ®æœåŠ¡è´Ÿè½½è‡ªåŠ¨è°ƒæ•´ä»»åŠ¡åˆ†å‘
2. **æ‰¹é‡å¤„ç†ä¼˜åŒ–**: æ”¯æŒå¤šæ–‡æ¡£æ‰¹é‡æäº¤åˆ° MinerU
3. **æ™ºèƒ½é‡è¯•ç­–ç•¥**: åŸºäºé”™è¯¯ç±»å‹çš„å·®å¼‚åŒ–é‡è¯•
4. **æ€§èƒ½é¢„æµ‹**: åŸºäºå†å²æ•°æ®é¢„æµ‹å¤„ç†æ—¶é—´
5. **èµ„æºç›‘æ§**: é›†æˆç³»ç»Ÿèµ„æºç›‘æ§å’Œè‡ªåŠ¨è°ƒèŠ‚

è¿™ä¸ªé›†æˆä¸º RAGFlow æä¾›äº†å¼ºå¤§çš„ MinerU æ”¯æŒï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯æ‰©å±•æ€§ã€‚
